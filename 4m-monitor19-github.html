<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4M Management System v7.2 (World Class Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.18/24/solid/css/heroicons.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .tab-button.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .form-section { border-left: 4px solid #3b82f6; }
        .risk-high { background-color: #fee2e2; color: #b91c1c; border-color: #ef4444; }
        .risk-medium { background-color: #fef3c7; color: #b45309; border-color: #f59e0b; }
        .risk-low { background-color: #dcfce7; color: #166534; border-color: #22c55e; }
        .qa-ok { color: #16a34a; } .qa-ng { color: #dc2626; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; font-weight: 600; }
        .card-section-header { font-size: 0.7rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;}
        .overdue-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* <<< [WORLD CLASS UPDATE] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Telegram */
        .card-highlight {
            animation: highlight-animation 2.5s ease-out;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.7); /* Blue glow */
            border-radius: 0.5rem; /* Ensure shadow follows card shape */
        }
        @keyframes highlight-animation {
            0% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.9); transform: scale(1.02); }
            70% { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); transform: scale(1); }
            100% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="app" class="container mx-auto max-w-7xl p-2 sm:p-4">
    <!-- Header -->
    <header class="bg-white shadow-md rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center">
             <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-blue-600"><path d="M12 9a3.75 3.75 0 100 7.5A3.75 3.75 0 0012 9z" /><path fill-rule="evenodd" d="M9.344 3.071a49.52 49.52 0 015.312 0c.967.052 1.83.585 2.342 1.374a3.026 3.026 0 01.64 2.288V17.5c0 .713-.388 1.354-.99 1.731a6.01 6.01 0 01-1.642.705 49.52 49.52 0 01-5.312 0 6.01 6.01 0 01-1.642-.705A2.25 2.25 0 013.75 17.5V6.733c0-.713.388-1.354.99-1.731a6.01 6.01 0 011.642-.705zM12 15a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" clip-rule="evenodd" /></svg>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800">4M Management System v7.2</h1>
                    <p class="text-sm text-gray-500">Integrated Command Center</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 text-sm"><i data-feather="download"></i></button>
                <button id="settingsBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 text-sm"><i data-feather="settings"></i></button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white rounded-t-lg shadow">
        <div class="flex border-b">
            <button data-view="form" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent active"><i class="w-5 h-5 inline-block" data-feather="edit"></i> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 4M</span></button>
            <button data-view="board" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent"><i class="w-5 h-5 inline-block" data-feather="grid"></i> <span>4M Board</span></button>
            <button data-view="dashboard" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent"><i class="w-5 h-5 inline-block" data-feather="bar-chart-2"></i> <span>Dashboard</span></button>
        </div>
    </nav>
    
    <main class="bg-white shadow-md rounded-b-lg p-4 sm:p-6 min-h-[60vh]">
        <div id="view-container"></div>
    </main>
</div>

<!-- All Modals -->
<div id="modal-container"></div>

<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
// ---------- SCRIPT FOR v7.2 ----------
// ** NEW FEATURES (World Class Update) **
// 1. Interactive Telegram Notifications with "View on Board" button.
// 2. Auto-Highlighting & Scrolling for cards opened via Telegram link.
// 3. Centralized BASE_URL configuration for easy deployment.
// 4. Enhanced Notification Message Structure for clarity.

document.addEventListener('DOMContentLoaded', () => {

    // +++ START: TELEGRAM CONFIGURATION +++
    // >>> ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ BOT TOKEN, CHAT ID ‡πÅ‡∏•‡∏∞ URL ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà <<<
    const TELEGRAM_CONFIG = {
        BOT_TOKEN: '7698218579:AAHb0vK959U_IXbRBYEmaXBGIxP3IsKn3uo', // Token ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó @TSPT1_4M_BOT (‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        CHAT_ID: '7956717161',      // <<<--- ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà CHAT ID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // <<< [WORLD CLASS UPDATE] URL ‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà
        // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
        // ‡πÄ‡∏ä‡πà‡∏ô 'content://media/external/file/1000035961'
        // ‡∏´‡∏≤‡∏Å‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Telegram ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        BASE_URL:'https://9chai-9chai.github.io/4m-system1/' // <<<--- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
    };
    // +++ END: TELEGRAM CONFIGURATION +++

    // --- TEMPLATES ---
    const TPL = {
        form: `<form id="changeForm" class="space-y-6"><input type="hidden" id="reportId"><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-4">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="changeType" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó 4M</label><select id="changeType" required class="mt-1 block w-full rounded-md border-gray-300"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option><option value="Man">Man</option><option value="Machine">Machine</option><option value="Material">Material</option><option value="Method">Method</option></select></div><div><label for="docNumber" class="block text-sm font-medium text-gray-700">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="docNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô WI-PR-001" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="changeLine" class="block text-sm font-medium text-gray-700">‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</label><input list="lines-list" type="text" id="changeLine" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="lines-list"></datalist></div><div><label for="partName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</label><input list="parts-list" type="text" id="partName" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="parts-list"></datalist></div><div class="sm:col-span-2"><label for="reporterName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" id="reporterName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" class="mt-1 block w-full rounded-md border-gray-300"></div></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><div class="flex justify-between items-center mb-2"><h3 class="text-lg font-semibold text-gray-700">2. ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h3><div class="text-right"><p class="text-sm text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p><p id="riskScoreDisplay" class="font-bold text-xl text-blue-600">0</p></div></div><p class="text-sm text-gray-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p><div id="reasonCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4"><p class="text-gray-400 col-span-full">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó 4M ‡∏Å‡πà‡∏≠‡∏ô</p></div><div><label for="otherReason" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><textarea id="otherReason" rows="2" class="mt-1 block w-full rounded-md border-gray-300" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-2">3. ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h3><p class="text-sm font-medium text-gray-700 mb-2">‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</p><div id="mainCountermeasuresCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4"><p class="text-gray-400 col-span-full">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó 4M ‡∏Å‡πà‡∏≠‡∏ô</p></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t pt-4"><div><label for="dueDate" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</label><input type="date" id="dueDate" required class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="responsible" class="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å</label><input list="responsibles-list" type="text" id="responsible" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="responsibles-list"></datalist></div></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-2">4. ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><p class="text-sm text-gray-500 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</p><div id="surveillanceMeasuresCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div><div class="flex items-center space-x-2 sm:col-span-2 mt-2 pt-2 border-t"><label for="surveillanceOtherCheckbox" class="flex items-center text-sm flex-shrink-0"><input type="checkbox" id="surveillanceOtherCheckbox" class="rounded border-gray-300"><span class="ml-2 text-gray-700">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏):</span></label><input type="text" id="surveillanceOtherText" class="hidden flex-grow rounded-md border-gray-300 text-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></div></div><div class="flex justify-end pt-4"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center space-x-2"><i class="w-6 h-6" data-feather="save"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></button></div></form>`,
        board: `<div class="bg-gray-50 p-4 rounded-lg mb-4 border grid grid-cols-1 sm:grid-cols-4 gap-4"><div><label for="filterDate" class="block text-sm text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="filterDate" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="filterText" class="block text-sm text-gray-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label><input type="text" id="filterText" placeholder="‡πÑ‡∏•‡∏ô‡πå, ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô, ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô..." class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="filterStatus" class="block text-sm text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="filterStatus" class="mt-1 block w-full rounded-md border-gray-300"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div><div><label for="filterRisk" class="block text-sm text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</label><select id="filterRisk" class="mt-1 block w-full rounded-md border-gray-300"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="High">‡∏™‡∏π‡∏á</option><option value="Medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="Low">‡∏ï‡πà‡∏≥</option></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"><div id="board-Man" class="bg-blue-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-blue-800 mb-3 text-center">MAN</h2><div class="space-y-3"></div></div><div id="board-Machine" class="bg-yellow-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-yellow-800 mb-3 text-center">MACHINE</h2><div class="space-y-3"></div></div><div id="board-Material" class="bg-green-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-green-800 mb-3 text-center">MATERIAL</h2><div class="space-y-3"></div></div><div id="board-Method" class="bg-purple-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-purple-800 mb-3 text-center">METHOD</h2><div class="space-y-3"></div></div></div><div id="no-data-message" class="hidden text-center text-gray-500 py-10"><i class="w-16 h-16 mx-auto text-gray-400" data-feather="folder-off"></i><p class="mt-4 text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>`,
        dashboard: `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h3><canvas id="reasonsChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á 4M</h3><canvas id="typesChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h3><canvas id="linesChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å 4M Change</h3><canvas id="defectsChart"></canvas></div></div>`,
        modals: `<div id="qaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Verification)</h3><form id="qaForm"><input type="hidden" id="qaReportId"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</label><div class="flex items-center space-x-4 mt-1"><label class="flex items-center"><input type="radio" name="qaResult" value="OK" class="text-green-600"><span class="ml-2 text-green-700 font-semibold">OK</span></label><label class="flex items-center"><input type="radio" name="qaResult" value="NG" class="text-red-600"><span class="ml-2 text-red-700 font-semibold">NG</span></label></div></div><div id="defectSection" class="hidden"><label for="defectCode" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><select id="defectCode" class="mt-1 block w-full rounded-md border-gray-300"></select></div><div><label for="verifiedBy" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (QA)</label><input type="text" id="verifiedBy" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏£ QC" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="qaEvidence" class="block text-sm font-medium text-gray-700">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</label><input type="file" id="qaEvidence" accept="image/*,.pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="imagePreview" class="hidden mt-2 max-h-40 rounded"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•</button></div></form></div></div> <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><h3 class="text-lg font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Master Data (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</h3><form id="settingsForm" class="space-y-4"><div><label for="masterParts" class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ,)</label><textarea id="masterParts" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div><div><label for="masterLines" class="block text-sm font-medium text-gray-700">‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ,)</label><textarea id="masterLines" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div><div><label for="masterResponsibles" class="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ,)</label><textarea id="masterResponsibles" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div></form><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button><button type="button" id="saveSettingsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤</button></div></div></div> <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><div class="flex justify-between items-center"><h3 class="text-lg font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Action History)</h3><button type="button" class="modal-close-btn text-gray-400 hover:text-gray-600">√ó</button></div><div id="historyContent" class="text-sm space-y-2 max-h-80 overflow-y-auto"></div></div></div>`
    };

    // --- DATA MAPPING ---
    const REASONS_BY_TYPE = {'Man': ['‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô/‡∏•‡∏≤','‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà','‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏≠','‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏∞/‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Job Leader','‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° WI','‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏•‡πâ‡∏≤/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û','‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'],'Machine': ['‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå (Mold)','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ Breakdown','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Parameter ‡∏â‡∏µ‡∏î','‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Jig/Fixture','‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà','‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡∏•‡∏°‡∏≠‡∏±‡∏î‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢/‡πÑ‡∏°‡πà Calibrate','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Robot Program','Cooling System ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤','Heater ‡∏Ç‡∏≤‡∏î'],'Material': ['‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Lot ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Å‡∏£‡∏î/Supplier','‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏î‡πÅ‡∏ó‡∏ô','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö Spec ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ/Masterbatch','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Packaging','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á','‡πÉ‡∏ä‡πâ Re-grind material','‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°/‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏¥‡∏î','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô'],'Method': ['‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Work Instruction (WI)','‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏° Cycle Time','‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Layout ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï','‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Trial)','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ Packing','‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Kaizen','‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô','‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö','‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ Set up ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ']};
    const newCountermeasure = '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à 5 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏ó‡∏∏‡∏Å 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á';
    const COUNTERMEASURES_BY_TYPE = {
        'Man': ['‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏°‡∏≤‡∏ó‡∏≥‡πÅ‡∏ó‡∏ô','‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°','‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ú‡∏•‡∏¥‡∏ï‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 100% ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏•‡∏ô‡πå', newCountermeasure, 'QC ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©','‡∏à‡∏±‡∏î‡∏ó‡∏≥ OPL ‡∏™‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô','‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£/‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°','‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏≤','‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô Skill Matrix'],
        'Machine': ['‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°','‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Parameter','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö First-off 5 ‡∏ä‡∏¥‡πâ‡∏ô','‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô', newCountermeasure, '‡πÅ‡∏¢‡∏Å Lot ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö','‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏£‡∏±‡∏ö Parameter','‡∏ï‡∏£‡∏ß‡∏à Calibrate ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î','‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°','‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô/Heater'],
        'Material': ['‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤','‡∏™‡πà‡∏á QA ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö','‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Supplier ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Spec','Trial run ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà','‡∏≠‡∏ö‡πÑ‡∏•‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ', newCountermeasure, '‡πÅ‡∏¢‡∏Å/‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢ Lot ‡πÉ‡∏´‡∏°‡πà','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö Lot ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ','‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏µ/‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û','‡∏Ç‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ CoA','‡∏Å‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢','‡∏õ‡∏£‡∏±‡∏ö Parameter ‡∏â‡∏µ‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞'],
        'Method': ['‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô WI','‡∏≠‡∏≠‡∏Å WI ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','QA ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏á‡∏≤‡∏ô','‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ñ‡∏∂‡∏á','‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', newCountermeasure, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Log Book','Audit ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô','‡∏ï‡∏£‡∏ß‡∏à First/Last Piece','‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©','‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô FMEA/Control Plan','‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° WI ‡πÉ‡∏´‡∏°‡πà']
    };
    const SURVEILLANCE_MEASURES = ['‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á \'4M Change\' ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á/Rack ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á QA', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô 100% ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á', '‡πÅ‡∏¢‡∏Å Lot ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ú‡∏• QA', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£/‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Parameter ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô 1 ‡∏ä‡∏°.', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÉ‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á First Shot / Last Shot ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏∞', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô OK/NG ‡∏ï‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏∞‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö', '‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Visual Defect ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Limit Sample'];
    const RISK_SCORES = {'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà':3,'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô/‡∏•‡∏≤':2,'‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà':2,'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏≠':4,'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ Breakdown':5,'‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô':5,'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Å‡∏£‡∏î/Supplier':4,'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö Spec ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á':4,'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô':5,'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Work Instruction (WI)':3,'‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Trial)':4};
    const DEFECT_CODES = ['‡πÑ‡∏°‡πà‡∏°‡∏µ','‡∏£‡∏≠‡∏¢‡∏ö‡∏∏‡∏ö (Dent)','‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô (Scratch)','‡πÅ‡∏ü‡∏•‡∏ä (Flash)','‡∏â‡∏µ‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° (Short Shot)','‡∏£‡∏≠‡∏¢‡∏¢‡∏∏‡∏ö (Sink Mark)','‡∏™‡∏µ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô (Color Mismatch)','‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô (Contamination)','‡∏Ç‡∏ô‡∏≤‡∏î‡∏ú‡∏¥‡∏î Spec (Dimension NG)','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
    const STATUS_WORKFLOW = {'Open':{text:'Open',color:'bg-gray-400 text-white',next:'Acknowledged',buttonText:'‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤'},'Acknowledged':{text:'‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß',color:'bg-yellow-500 text-white',next:'Action Taken',buttonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'},'Action Taken':{text:'‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß',color:'bg-blue-500 text-white',next:'Verified',buttonText:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• (QA)'},'Verified':{text:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß',color:'bg-indigo-500 text-white',next:'Closed',buttonText:'‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'},'Closed':{text:'Closed',color:'bg-green-600 text-white',next:null,buttonText:null}};
    
    // --- STATE ---
    let reports = [];
    let masterData = { parts: [], lines: [], responsibles: [] };
    let appDOMElements = {};
    let highlightedReportId = null; // <<< [WORLD CLASS UPDATE] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå

    // +++ START: TELEGRAM FUNCTION (UPGRADED) +++
    // <<< [WORLD CLASS UPDATE] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Action
    async function sendTelegramNotification(message, actionUrl = null) {
        if (!TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID || TELEGRAM_CONFIG.CHAT_ID === 'YOUR_CHAT_ID_HERE') {
            const simulatedMessage = actionUrl ? `${message}\n\n[‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á: ‡∏î‡∏π‡∏ö‡∏ô Board]\n(‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${actionUrl})` : message;
            console.error('Telegram BOT_TOKEN or CHAT_ID is not configured.');
            showNotification(`[‡∏à‡∏≥‡∏•‡∏≠‡∏á Telegram]\n${simulatedMessage.replace(/[*_~`>#+\-=|{}.!]/g, '\\$&')}`);
            return;
        }

        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
        const params = new URLSearchParams({
            chat_id: TELEGRAM_CONFIG.CHAT_ID,
            text: message,
            parse_mode: 'Markdown'
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Inline ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ actionUrl ‡πÅ‡∏•‡∏∞ BASE_URL ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        if (actionUrl && TELEGRAM_CONFIG.BASE_URL) {
            const inline_keyboard = {
                inline_keyboard: [[
                    { text: 'üìã ‡∏î‡∏π‡∏ö‡∏ô 4M Board', url: actionUrl }
                ]]
            };
            params.append('reply_markup', JSON.stringify(inline_keyboard));
        }

        try {
            const response = await fetch(`${url}?${params.toString()}`, { method: 'GET' });
            const data = await response.json();
            if (data.ok) {
                console.log('Telegram message sent successfully!');
            } else {
                console.error('Failed to send Telegram message:', data.description);
                alert(`Error sending Telegram message: ${data.description}`);
            }
        } catch (error) {
            console.error('Error sending Telegram notification:', error);
            alert(`Network error while sending Telegram notification.`);
        }
    }
    // +++ END: TELEGRAM FUNCTION +++

    // --- MAIN FUNCTIONS ---
    function init() {
        document.getElementById('view-container').innerHTML = TPL.form;
        document.getElementById('modal-container').innerHTML = TPL.modals;
        initializeDomElements();
        
        // <<< [WORLD CLASS UPDATE] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL parameters ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå
        handleUrlParameters();

        loadMasterData();
        loadData();
        setupEventListeners();
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ form ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        if (!highlightedReportId) {
            switchView('form');
        }
        feather.replace();
    }
    
    // <<< [WORLD CLASS UPDATE] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL parameters
    function handleUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view');
        const highlightId = params.get('highlight');

        if (highlightId) {
            highlightedReportId = parseInt(highlightId);
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ board ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ parameter highlight
            switchView('board');
        } else if (view) {
            switchView(view);
        }
    }

    function initializeDomElements() {
        appDOMElements = {
            viewContainer: document.getElementById('view-container'),
            tabButtons: document.querySelectorAll('.tab-button'), exportBtn: document.getElementById('exportBtn'), settingsBtn: document.getElementById('settingsBtn'),
            modals: { qa: document.getElementById('qaModal'), settings: document.getElementById('settingsModal'), history: document.getElementById('historyModal') },
            settingsForm: { form: document.getElementById('settingsForm'), parts: document.getElementById('masterParts'), lines: document.getElementById('masterLines'), responsibles: document.getElementById('masterResponsibles'), saveBtn: document.getElementById('saveSettingsBtn') },
            historyContent: document.getElementById('historyContent')
        };
    }

    function setupEventListeners() {
        appDOMElements.tabButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        appDOMElements.exportBtn.addEventListener('click', exportToExcel);
        appDOMElements.settingsBtn.addEventListener('click', openSettingsModal);
        document.getElementById('modal-container').addEventListener('click', e => {
            if (e.target.classList.contains('modal-close-btn')) {
                e.target.closest('.fixed').classList.add('hidden');
            }
        });
        appDOMElements.settingsForm.saveBtn.addEventListener('click', saveSettings);
    }
    
    function setupViewEventListeners(view) {
        if(view === 'form') {
            const form = document.getElementById('changeForm');
            form.addEventListener('submit', handleFormSubmit);
            document.getElementById('changeType').addEventListener('change', updateDynamicFormElements);
            document.getElementById('reasonCheckboxes').addEventListener('change', calculateRiskScore);
            document.getElementById('surveillanceOtherCheckbox')?.addEventListener('change', e => {
                document.getElementById('surveillanceOtherText').classList.toggle('hidden', !e.target.checked);
                if (e.target.checked) {
                    document.getElementById('surveillanceOtherText').focus();
                }
            });
        }
        if(view === 'board') {
            document.querySelectorAll('#filterDate, #filterText, #filterStatus, #filterRisk').forEach(filter => {
                filter.addEventListener('input', renderBoard);
            });
        }
        if(view === 'qaModal') {
            const qaForm = document.getElementById('qaForm');
            qaForm.addEventListener('submit', handleQaSubmit);
            qaForm.qaResult.forEach(radio => radio.addEventListener('change', e => {
                document.getElementById('defectSection').style.display = e.target.value === 'NG' ? 'block' : 'none';
            }));
        }
    }

    function switchView(viewName) {
        // <<< [WORLD CLASS UPDATE] ‡∏•‡πâ‡∏≤‡∏á highlightId ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô view ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
        if (viewName !== 'board' && highlightedReportId) {
             highlightedReportId = null;
        }

        appDOMElements.tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
        appDOMElements.viewContainer.innerHTML = TPL[viewName];
        if (viewName === 'form') {
            updateDynamicFormElements();
            populateDatalists();
            setupViewEventListeners('form');
        }
        if (viewName === 'board') {
            populateStaticDropdowns();
            renderBoard();
            setupViewEventListeners('board');
        }
        if (viewName === 'dashboard') renderDashboard();
        feather.replace();
    }
    
    function handleFormSubmit(e) {
        e.preventDefault();
        const score = calculateRiskScore();
        if (score === 0 && !document.getElementById('otherReason').value) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠'); return; }
        
        const surveillanceMeasures = getCheckedValues(document.getElementById('surveillanceMeasuresCheckboxes'));
        const otherCheckbox = document.getElementById('surveillanceOtherCheckbox');
        const otherText = document.getElementById('surveillanceOtherText');
        if (otherCheckbox.checked && otherText.value.trim() !== '') {
            surveillanceMeasures.push(`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${otherText.value.trim()}`);
        }

        const reportId = document.getElementById('reportId').value;
        const reporterName = document.getElementById('reporterName').value;

        if (reportId) { // --- UPDATE EXISTING REPORT ---
            const reportToUpdate = reports.find(r => r.id == reportId);
            if(reportToUpdate) {
                reportToUpdate.type = document.getElementById('changeType').value;
                reportToUpdate.line = document.getElementById('changeLine').value;
                reportToUpdate.partName = document.getElementById('partName').value;
                reportToUpdate.reporter = reporterName;
                reportToUpdate.docNumber = document.getElementById('docNumber').value;
                reportToUpdate.risk = { score: score, level: score > 7 ? 'High' : (score > 3 ? 'Medium' : 'Low') };
                reportToUpdate.reason = [...getCheckedValues(document.getElementById('reasonCheckboxes')), ...(document.getElementById('otherReason').value ? [`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${document.getElementById('otherReason').value}`] : [])].join('; ');
                reportToUpdate.countermeasure.main = getCheckedValues(document.getElementById('mainCountermeasuresCheckboxes'));
                reportToUpdate.countermeasure.surveillance = surveillanceMeasures;
                reportToUpdate.countermeasure.dueDate = document.getElementById('dueDate').value;
                reportToUpdate.countermeasure.responsible = document.getElementById('responsible').value;
                
                addHistory(reportToUpdate, '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', reporterName);
                showNotification('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            }
        } else { // --- CREATE NEW REPORT ---
            const newReport = {
                id: Date.now(), timestamp: new Date().toISOString(), type: document.getElementById('changeType').value,
                line: document.getElementById('changeLine').value, partName: document.getElementById('partName').value, reporter: reporterName, docNumber: document.getElementById('docNumber').value,
                risk: { score: score, level: score > 7 ? 'High' : (score > 3 ? 'Medium' : 'Low') },
                reason: [...getCheckedValues(document.getElementById('reasonCheckboxes')), ...(document.getElementById('otherReason').value ? [`‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${document.getElementById('otherReason').value}`] : [])].join('; '),
                countermeasure: {
                    main: getCheckedValues(document.getElementById('mainCountermeasuresCheckboxes')), 
                    surveillance: surveillanceMeasures, 
                    dueDate: document.getElementById('dueDate').value, 
                    responsible: document.getElementById('responsible').value, 
                    notes: ''
                },
                status: 'Open', 
                qa: { result: null, evidence: null, timestamp: null, defect: null, verifiedBy: null },
                history: [{ timestamp: new Date().toISOString(), action: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™', user: reporterName }]
            };
            reports.unshift(newReport);
            
            // +++ SEND TELEGRAM NOTIFICATION FOR NEW CASE (UPGRADED) +++
            const riskEmoji = newReport.risk.level === 'High' ? 'üö®' : (newReport.risk.level === 'Medium' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è');
            const message = `
${riskEmoji} *New 4M Change*
*Case ID:* \`${newReport.id}\`
*Type:* ${newReport.type}
*Part:* ${newReport.partName}
*Line:* ${newReport.line}
*Risk:* ${newReport.risk.level} (${newReport.risk.score})
*Reason:* ${newReport.reason.substring(0, 100)}...
--------------------------------------
üë§ *‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:* ${newReport.countermeasure.responsible}
üëâ *‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Acknowledge)*
            `.trim();
            // <<< [WORLD CLASS UPDATE] ‡∏™‡πà‡∏á URL ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Notification
            const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${newReport.id}`;
            sendTelegramNotification(message, actionUrl);

            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß!');
        }

        saveData();
        switchView('board');
    }

    // --- CARD & WORKFLOW ---
    function createReportCard(report) {
        const card = document.createElement('div');
        // <<< [WORLD CLASS UPDATE] ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Element ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
        card.id = `report-card-${report.id}`;
        card.className = "bg-white rounded-lg shadow-md border-t-4 p-3 flex flex-col space-y-3";
        const riskClass = report.risk.level === 'High' ? 'risk-high' : (report.risk.level === 'Medium' ? 'risk-medium' : 'risk-low');
        const typeColorMapping = {'Man':'border-blue-500', 'Machine':'border-yellow-500', 'Material':'border-green-500', 'Method':'border-purple-500'};
        card.classList.add(typeColorMapping[report.type]);

        const isOverdue = !['Closed'].includes(report.status) && new Date(report.countermeasure.dueDate) < new Date();
        const statusInfo = STATUS_WORKFLOW[report.status];
        
        const formattedDate = new Date(report.timestamp).toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        const qaSummary = report.qa.result 
            ? `<div class="p-2 rounded-md bg-gray-100 text-xs mt-1"><p><strong>‡∏ú‡∏•:</strong> <span class="font-bold ${report.qa.result === 'OK' ? 'qa-ok' : 'qa-ng'}">${report.qa.result}</span></p>${report.qa.defect && report.qa.defect !== '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? `<p><strong>‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢:</strong> ${report.qa.defect}</p>` : ''}<p><strong>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</strong> ${report.qa.verifiedBy || 'N/A'}</p></div>`
            : '';
            
        let actionButton = statusInfo.next 
            ? `<button data-id="${report.id}" data-action="${report.status}" class="action-btn w-full mt-auto text-sm py-1.5 rounded font-semibold ${statusInfo.color} hover:opacity-80">${statusInfo.buttonText}</button>`
            : `<div class="text-center text-sm py-1.5 text-green-700 font-semibold">Completed</div>`;
        
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="text-base font-bold text-gray-900 leading-tight">${report.partName}</h4>
                        <p class="text-sm font-semibold text-gray-500">${report.line}</p>
                        <p class="text-xs text-gray-400 mt-1">${formattedDate} ‡∏ô.</p>
                    </div>
                    <div class="flex-shrink-0 flex flex-col items-end space-y-1">
                        <span class="status-badge ${riskClass}">${report.risk.level} Risk (${report.risk.score})</span>
                        <span class="status-badge ${statusInfo.color}">${statusInfo.text}</span>
                        ${isOverdue ? `<span class="status-badge bg-red-600 text-white overdue-pulse">OVERDUE</span>` : ''}
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded" title="${report.reason}"><i data-feather="alert-circle" class="w-3 h-3 inline-block -mt-1"></i> ${report.reason.substring(0, 80)}...</p>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-xs border-t pt-2">
                <div title="‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"><i data-feather="user" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${report.reporter}</span></div>
                <div title="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"><i data-feather="user-check" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${report.countermeasure.responsible}</span></div>
                <div title="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à"><i data-feather="calendar" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${new Date(report.countermeasure.dueDate).toLocaleDateString('th-TH')}</span></div>
            </div>

            <details class="text-xs bg-gray-50 rounded">
                <summary class="cursor-pointer p-1 font-semibold text-gray-600">‡∏î‡∏π‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£ & ‡∏ú‡∏• QA...</summary>
                <div class="p-2 border-t space-y-2">
                    ${(report.countermeasure.main && report.countermeasure.main.length > 0) ? `<div><p class="card-section-header">‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡∏´‡∏•‡∏±‡∏Å</p><ul class="list-disc list-inside text-gray-700">${report.countermeasure.main.map(c => `<li>${c}</li>`).join('')}</ul></div>` : ''}
                    ${(report.countermeasure.surveillance && report.countermeasure.surveillance.length > 0) ? `<div><p class="card-section-header">‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</p><ul class="list-disc list-inside text-gray-700">${report.countermeasure.surveillance.map(s => `<li>${s}</li>`).join('')}</ul></div>` : ''}
                    <div><p class="card-section-header">Action Log</p><p class="text-gray-700 italic">${report.countermeasure.notes || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}</p></div>
                    <div><p class="card-section-header">Verification Summary</p>${qaSummary || '<p class="text-gray-500 italic">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>'}</div>
                </div>
            </details>
            
            <div class="border-t pt-2 mt-auto flex justify-between items-center">
                <div class="flex-grow pr-2">${actionButton}</div>
                <div class="flex-shrink-0 flex items-center space-x-1">
                    <button title="‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" data-id="${report.id}" class="remind-btn text-gray-400 hover:text-blue-600 p-1 ${report.status === 'Closed' ? 'hidden' : ''}"><i data-feather="bell" class="w-4 h-4"></i></button>
                    <button title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" data-id="${report.id}" class="history-btn text-gray-400 hover:text-blue-600 p-1"><i data-feather="clock" class="w-4 h-4"></i></button>
                    <button title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" data-id="${report.id}" class="edit-btn text-gray-400 hover:text-yellow-600 p-1"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                    <button title="‡∏•‡∏ö" data-id="${report.id}" class="delete-btn text-gray-400 hover:text-red-600 p-1"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        `;
        card.querySelector('.action-btn')?.addEventListener('click', handleActionClick);
        card.querySelector('.remind-btn')?.addEventListener('click', handleRemindClick);
        card.querySelector('.history-btn')?.addEventListener('click', showHistoryModal);
        card.querySelector('.edit-btn')?.addEventListener('click', handleEditClick);
        card.querySelector('.delete-btn')?.addEventListener('click', handleDeleteClick);
        return card;
    }

    // +++ Manual Reminder Click Handler (UPGRADED) +++
    async function handleRemindClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const report = reports.find(r => r.id === id);
        if (!report) return;

        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ #${report.id} (${report.partName}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

        let message, actionNeeded = '', target = '';
        switch (report.status) {
            case 'Open': target = report.countermeasure.responsible; actionNeeded = '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Acknowledge)'; break;
            case 'Acknowledged': target = report.countermeasure.responsible; actionNeeded = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Action Taken)'; break;
            case 'Action Taken': target = '‡∏ó‡∏µ‡∏° QA'; actionNeeded = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• (Verification)'; break;
            case 'Verified': report.qa.result === 'NG' ? (target = report.countermeasure.responsible, actionNeeded = `‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ú‡∏• QA ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô NG`) : (target = report.countermeasure.responsible, actionNeeded = `‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (Close Case)`); break;
            default: showNotification('‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'); return;
        }

        message = `
üîî *Reminder: 4M Change*
*Case ID:* \`${report.id}\` (${report.partName})
*Line:* ${report.line}
*Current Status:* ${STATUS_WORKFLOW[report.status].text}
--------------------------------------
‚ÄºÔ∏è *‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:* ${target}
üëâ *‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ:* ${actionNeeded}
        `.trim();
        // <<< [WORLD CLASS UPDATE] ‡∏™‡πà‡∏á URL ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Notification
        const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;
        await sendTelegramNotification(message, actionUrl);
        showNotification('‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }
    
    function handleActionClick(e) {
        const id = parseInt(e.target.dataset.id), action = e.target.dataset.action;
        const report = reports.find(r => r.id === id);
        if (!report) return;

        const nextStatus = STATUS_WORKFLOW[action].next;
        const user = prompt(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:`, report.reporter);
        if (!user) return;
        
        let message = '';
        // <<< [WORLD CLASS UPDATE] ‡∏™‡πà‡∏á URL ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Notification
        const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;

        if (action === 'Open') { 
            report.status = nextStatus;
            addHistory(report, '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤', user);
            showNotification(`‡πÄ‡∏Ñ‡∏™ #${report.id} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Acknowledge ‡πÅ‡∏•‡πâ‡∏ß`);
        } else if (action === 'Acknowledged') { 
            const notes = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:', report.countermeasure.notes);
            if(notes !== null) { 
                report.countermeasure.notes = notes; 
                report.status = nextStatus;
                addHistory(report, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', user);
                message = `
üìù *Action Taken*
*Case ID:* \`${report.id}\` (${report.partName})
*Action Note:* ${notes}
*Taken by:* ${user}
--------------------------------------
üî¨ *‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏ó‡∏µ‡∏° QA*
üëâ *‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Verification)*
                `.trim();
                sendTelegramNotification(message, actionUrl);
            }
        } else if (action === 'Action Taken') { openQaModal(id); return; } 
        else if (action === 'Verified') {
            if(report.qa.result !== 'OK') { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏• QA ‡πÄ‡∏õ‡πá‡∏ô NG'); return; }
            report.status = nextStatus;
            addHistory(report, '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô', user);
            message = `
üèÅ *Case Closed*
*Case ID:* \`${report.id}\` (${report.partName})
*Line:* ${report.line}
*Closed by:* ${user}
--------------------------------------
‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            `.trim();
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á link ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
            sendTelegramNotification(message);
            showNotification(`‡πÄ‡∏Ñ‡∏™ #${report.id} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
        
        saveData();
        renderBoard();
    }

    function handleDeleteClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const reportToDelete = reports.find(r => r.id === id);
        if (reportToDelete && confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á '${reportToDelete.partName}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            reports = reports.filter(r => r.id !== id);
            saveData();
            renderBoard();
            showNotification('‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
    }

    function handleEditClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const reportToEdit = reports.find(r => r.id === id);
        if (reportToEdit) {
            switchView('form');
            populateFormForEdit(reportToEdit);
        }
    }

    function populateFormForEdit(report) {
        document.getElementById('reportId').value = report.id;
        document.getElementById('changeType').value = report.type;
        document.getElementById('docNumber').value = report.docNumber;
        document.getElementById('changeLine').value = report.line;
        document.getElementById('partName').value = report.partName;
        document.getElementById('reporterName').value = report.reporter;
        updateDynamicFormElements();
        const reasons = report.reason.split('; ');
        reasons.forEach(reason => {
            if (reason.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ:')) {
                document.getElementById('otherReason').value = reason.replace('‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ', '');
            } else {
                const checkbox = document.querySelector(`#reasonCheckboxes input[value="${reason}"]`);
                if(checkbox) checkbox.checked = true;
            }
        });
        report.countermeasure.main.forEach(measure => {
            const checkbox = document.querySelector(`#mainCountermeasuresCheckboxes input[value="${measure}"]`);
            if(checkbox) checkbox.checked = true;
        });
        report.countermeasure.surveillance.forEach(measure => {
            if (measure.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ:')) {
                document.getElementById('surveillanceOtherCheckbox').checked = true;
                document.getElementById('surveillanceOtherText').value = measure.replace('‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ', '');
                document.getElementById('surveillanceOtherText').classList.remove('hidden');
            } else {
                const checkbox = document.querySelector(`#surveillanceMeasuresCheckboxes input[value="${measure}"]`);
                if(checkbox) checkbox.checked = true;
            }
        });
        document.getElementById('dueDate').value = report.countermeasure.dueDate;
        document.getElementById('responsible').value = report.countermeasure.responsible;
        calculateRiskScore();
    }
    
    function handleQaSubmit(e) {
        e.preventDefault();
        const qaForm = e.target;
        const id = parseInt(qaForm.querySelector('#qaReportId').value);
        const report = reports.find(r => r.id === id);
        if (report) {
            report.qa.result = qaForm.qaResult.value;
            report.qa.defect = report.qa.result === 'NG' ? qaForm.querySelector('#defectCode').value : null;
            report.qa.verifiedBy = qaForm.querySelector('#verifiedBy').value;
            report.qa.timestamp = new Date().toISOString();
            report.status = 'Verified';
            addHistory(report, `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•: ${report.qa.result}`, report.qa.verifiedBy);
            
            // +++ SEND TELEGRAM NOTIFICATION FOR QA RESULT (UPGRADED) +++
            const resultEmoji = report.qa.result === 'OK' ? '‚úÖ' : '‚ùå';
            const target = report.countermeasure.responsible;
            const resultText = `
${resultEmoji} *QA Verification Result*
*Case ID:* \`${report.id}\` (${report.partName})
*Result:* *${report.qa.result}*
${report.qa.result === 'NG' ? `*Defect:* ${report.qa.defect}` : ''}
*Verified by:* ${report.qa.verifiedBy}
--------------------------------------
üë§ *‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:* ${target}
üëâ *‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (${report.qa.result === 'OK' ? 'Close Case' : 'Re-Action'})*
            `.trim();
            // <<< [WORLD CLASS UPDATE] ‡∏™‡πà‡∏á URL ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Notification
            const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;
            sendTelegramNotification(resultText, actionUrl);

            saveData();
            renderBoard();
            appDOMElements.modals.qa.classList.add('hidden');
        }
    }

    // --- MODALS & NOTIFICATIONS ---
    function openSettingsModal() {
        appDOMElements.settingsForm.parts.value = masterData.parts.join(', ');
        appDOMElements.settingsForm.lines.value = masterData.lines.join(', ');
        appDOMElements.settingsForm.responsibles.value = masterData.responsibles.join(', ');
        appDOMElements.modals.settings.classList.remove('hidden');
    }
    
    function saveSettings() {
        masterData.parts = appDOMElements.settingsForm.parts.value.split(',').map(s => s.trim()).filter(Boolean);
        masterData.lines = appDOMElements.settingsForm.lines.value.split(',').map(s => s.trim()).filter(Boolean);
        masterData.responsibles = appDOMElements.settingsForm.responsibles.value.split(',').map(s => s.trim()).filter(Boolean);
        localStorage.setItem('4m_master_data_v7', JSON.stringify(masterData));
        showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Master Data ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        appDOMElements.modals.settings.classList.add('hidden');
        if (document.getElementById('changeForm')) populateDatalists();
    }
    
    function showHistoryModal(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const report = reports.find(r => r.id === id);
        if(!report || !report.history) { appDOMElements.historyContent.innerHTML = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; return; }
        
        appDOMElements.historyContent.innerHTML = report.history.map(h => 
            `<div class="border-b pb-2"><p><strong>${h.action}</strong> ‡πÇ‡∏î‡∏¢ ${h.user}</p><p class="text-gray-500">${new Date(h.timestamp).toLocaleString('th-TH')}</p></div>`
        ).join('');
        appDOMElements.modals.history.classList.remove('hidden');
    }
    
    function showNotification(message) {
        alert(message); // Simple simulation for user feedback
    }

    // --- HELPERS & UTILITIES ---
    function addHistory(report, action, user) {
        if (!report.history) report.history = [];
        report.history.push({ timestamp: new Date().toISOString(), action: action, user: user });
    }
    
    function populateDatalists() {
        document.getElementById('parts-list').innerHTML = masterData.parts.map(p => `<option value="${p}">`).join('');
        document.getElementById('lines-list').innerHTML = masterData.lines.map(l => `<option value="${l}">`).join('');
        document.getElementById('responsibles-list').innerHTML = masterData.responsibles.map(r => `<option value="${r}">`).join('');
    }
    
    function populateStaticDropdowns() { document.querySelector('#filterStatus').innerHTML = `<option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + Object.keys(STATUS_WORKFLOW).map(s => `<option value="${s}">${STATUS_WORKFLOW[s].text}</option>`).join(''); document.getElementById('defectCode').innerHTML = DEFECT_CODES.map(d => `<option value="${d}">${d}</option>`).join(''); }
    
    function updateDynamicFormElements() { 
        const type = document.getElementById('changeType')?.value; 
        updateCheckboxes(document.getElementById('reasonCheckboxes'), REASONS_BY_TYPE[type] || []); 
        updateCheckboxes(document.getElementById('mainCountermeasuresCheckboxes'), COUNTERMEASURES_BY_TYPE[type] || []); 
        updateCheckboxes(document.getElementById('surveillanceMeasuresCheckboxes'), SURVEILLANCE_MEASURES);
        calculateRiskScore(); 
    }
    
    function updateCheckboxes(container, options) { if (!container) return; container.innerHTML = options.length === 0 ? `<p class="text-gray-400 col-span-full">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó 4M ‡∏Å‡πà‡∏≠‡∏ô</p>` : options.map((option, i) => `<label for="${container.id}-${i}" class="flex items-center text-sm"><input type="checkbox" id="${container.id}-${i}" value="${option}" class="rounded border-gray-300"><span class="ml-2 text-gray-700">${option}</span></label>`).join(''); }
    function calculateRiskScore() { let score = 0; getCheckedValues(document.getElementById('reasonCheckboxes')).forEach(reason => { score += (RISK_SCORES[reason] || 1); }); document.getElementById('riskScoreDisplay').textContent = score; return score; }
    function getCheckedValues(container) { return Array.from(container.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value); }
    // <<< [WORLD CLASS UPDATE] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á renderBoard ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå
    function renderBoard() { const board = document.querySelector('#view-container'); if(!board) return; const Man = board.querySelector('#board-Man .space-y-3'), Machine = board.querySelector('#board-Machine .space-y-3'), Material = board.querySelector('#board-Material .space-y-3'), Method = board.querySelector('#board-Method .space-y-3'); [Man, Machine, Material, Method].forEach(c => c.innerHTML = ''); const fD = board.querySelector('#filterDate'), fT = board.querySelector('#filterText'), fS = board.querySelector('#filterStatus'), fR = board.querySelector('#filterRisk'); const filteredReports = reports.filter(r => { const dF = fD.value ? r.timestamp.startsWith(fD.value) : true; const tFV = fT.value.toLowerCase(); const tF = tFV ? r.line.toLowerCase().includes(tFV) || r.partName.toLowerCase().includes(tFV) || r.reporter.toLowerCase().includes(tFV) : true; const sF = fS.value ? r.status === fS.value : true; const rF = fR.value ? r.risk.level === fR.value : true; return dF && tF && sF && rF; }); board.querySelector('#no-data-message').style.display = filteredReports.length === 0 ? 'block' : 'none'; filteredReports.forEach(report => { const card = createReportCard(report); const container = report.type === 'Man' ? Man : report.type === 'Machine' ? Machine : report.type === 'Material' ? Material : Method; container.appendChild(card); }); feather.replace(); if(highlightedReportId){const cardToHighlight=document.getElementById(`report-card-${highlightedReportId}`);if(cardToHighlight){cardToHighlight.classList.add('card-highlight');cardToHighlight.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>cardToHighlight.classList.remove('card-highlight'),2500);}highlightedReportId=null;}}
    function openQaModal(id) { const report = reports.find(r => r.id === id); appDOMElements.modals.qa.querySelector('#qaReportId').value = id; appDOMElements.modals.qa.querySelector('form').reset(); appDOMElements.modals.qa.querySelector('#verifiedBy').value = ''; appDOMElements.modals.qa.querySelector('#defectSection').style.display = 'none'; appDOMElements.modals.qa.classList.remove('hidden'); }
    function renderDashboard() { if(reports.length === 0) { document.getElementById('view-container').innerHTML = '<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</p>'; return; } const reasonCounts = reports.flatMap(r => r.reason.split('; ').filter(reason => !reason.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ:'))).reduce((acc, reason) => { acc[reason] = (acc[reason] || 0) + 1; return acc; }, {}); const top5Reasons = Object.entries(reasonCounts).sort(([,a],[,b]) => b-a).slice(0, 5); const typeCounts = reports.reduce((acc, r) => { acc[r.type] = (acc[r.type] || 0) + 1; return acc; }, {}); const lineCounts = reports.reduce((acc, r) => { acc[r.line] = (acc[r.line] || 0) + 1; return acc; }, {}); const top5Lines = Object.entries(lineCounts).sort(([,a],[,b]) => b-a).slice(0, 5); const defectCounts = reports.filter(r => r.qa.result === 'NG' && r.qa.defect !== '‡πÑ‡∏°‡πà‡∏°‡∏µ').reduce((acc, r) => { acc[r.qa.defect] = (acc[r.qa.defect] || 0) + 1; return acc; }, {}); createChart('reasonsChart', 'bar', top5Reasons.map(item => item[0]), top5Reasons.map(item => item[1]), '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); createChart('typesChart', 'pie', Object.keys(typeCounts), Object.values(typeCounts)); createChart('linesChart', 'bar', top5Lines.map(item => item[0]), top5Lines.map(item => item[1]), '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); createChart('defectsChart', 'bar', Object.keys(defectCounts), Object.values(defectCounts), '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); }
    function createChart(canvasId, type, labels, data, label) { const ctx = document.getElementById(canvasId)?.getContext('2d'); if (!ctx) return; if(appDOMElements.charts && appDOMElements.charts[canvasId]) appDOMElements.charts[canvasId].destroy(); if(!appDOMElements.charts) appDOMElements.charts = {}; appDOMElements.charts[canvasId] = new Chart(ctx, { type: type, data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#ef4444', '#6b7280'] }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: type === 'pie' } } } }); }
    function saveData(){ localStorage.setItem('4m_reports_v7', JSON.stringify(reports)); }
    function loadData(){ const data = localStorage.getItem('4m_reports_v7'); if(data) {reports = JSON.parse(data);} }
    function loadMasterData(){ const data = localStorage.getItem('4m_master_data_v7'); if(data) {masterData = JSON.parse(data);} }
    function exportToExcel(){ showNotification('Exporting to Excel... (Simulation)'); }

    init();
});
</script>
</body>
</html>