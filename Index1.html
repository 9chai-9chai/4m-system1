<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4M Management System v7.2 (World Class Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.18/24/solid/css/heroicons.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .tab-button.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .form-section { border-left: 4px solid #3b82f6; }
        .risk-high { background-color: #fee2e2; color: #b91c1c; border-color: #ef4444; }
        .risk-medium { background-color: #fef3c7; color: #b45309; border-color: #f59e0b; }
        .risk-low { background-color: #dcfce7; color: #166534; border-color: #22c55e; }
        .qa-ok { color: #16a34a; } .qa-ng { color: #dc2626; }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; font-weight: 600; }
        .card-section-header { font-size: 0.7rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;}
        .overdue-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* <<< [WORLD CLASS UPDATE] CSS สำหรับไฮไลท์การ์ดที่ถูกเรียกจาก Telegram */
        .card-highlight {
            animation: highlight-animation 2.5s ease-out;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.7); /* Blue glow */
            border-radius: 0.5rem; /* Ensure shadow follows card shape */
        }
        @keyframes highlight-animation {
            0% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.9); transform: scale(1.02); }
            70% { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); transform: scale(1); }
            100% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="app" class="container mx-auto max-w-7xl p-2 sm:p-4">
    <!-- Header -->
    <header class="bg-white shadow-md rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center">
             <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-blue-600"><path d="M12 9a3.75 3.75 0 100 7.5A3.75 3.75 0 0012 9z" /><path fill-rule="evenodd" d="M9.344 3.071a49.52 49.52 0 015.312 0c.967.052 1.83.585 2.342 1.374a3.026 3.026 0 01.64 2.288V17.5c0 .713-.388 1.354-.99 1.731a6.01 6.01 0 01-1.642.705 49.52 49.52 0 01-5.312 0 6.01 6.01 0 01-1.642-.705A2.25 2.25 0 013.75 17.5V6.733c0-.713.388-1.354.99-1.731a6.01 6.01 0 011.642-.705zM12 15a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" clip-rule="evenodd" /></svg>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800">4M Management System v7.2</h1>
                    <p class="text-sm text-gray-500">Integrated Command Center</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 text-sm"><i data-feather="download"></i></button>
                <button id="settingsBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg flex items-center space-x-2 text-sm"><i data-feather="settings"></i></button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white rounded-t-lg shadow">
        <div class="flex border-b">
            <button data-view="form" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent active"><i class="w-5 h-5 inline-block" data-feather="edit"></i> <span>บันทึก 4M</span></button>
            <button data-view="board" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent"><i class="w-5 h-5 inline-block" data-feather="grid"></i> <span>4M Board</span></button>
            <button data-view="dashboard" class="tab-button flex-1 py-3 px-2 text-center text-gray-600 border-b-4 border-transparent"><i class="w-5 h-5 inline-block" data-feather="bar-chart-2"></i> <span>Dashboard</span></button>
        </div>
    </nav>
    
    <main class="bg-white shadow-md rounded-b-lg p-4 sm:p-6 min-h-[60vh]">
        <div id="view-container"></div>
    </main>
</div>

<!-- All Modals -->
<div id="modal-container"></div>

<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script>
// ---------- SCRIPT FOR v7.2 ----------
// ** NEW FEATURES (World Class Update) **
// 1. Interactive Telegram Notifications with "View on Board" button.
// 2. Auto-Highlighting & Scrolling for cards opened via Telegram link.
// 3. Centralized BASE_URL configuration for easy deployment.
// 4. Enhanced Notification Message Structure for clarity.

document.addEventListener('DOMContentLoaded', () => {

    // +++ START: TELEGRAM CONFIGURATION +++
    // >>> ใส่ค่า BOT TOKEN, CHAT ID และ URL ของแอพพลิเคชันของคุณที่นี่ <<<
    const TELEGRAM_CONFIG = {
        BOT_TOKEN: '7698218579:AAHb0vK959U_IXbRBYEmaXBGIxP3IsKn3uo', // Token ของบอท @TSPT1_4M_BOT (ใส่ให้แล้ว)
        CHAT_ID: '7956717161',      // <<<--- คุณต้องใส่ CHAT ID ของกลุ่มที่นี่
        // <<< [WORLD CLASS UPDATE] URL ที่แอพพลิเคชันนี้ถูกโฮสต์อยู่
        // สำคัญมาก: ต้องเปลี่ยนเป็น URL จริงที่ทุกคนในทีมสามารถเข้าถึงได้
        // เช่น 'content://media/external/file/1000035961'
        // หากปล่อยเป็นค่าว่าง ปุ่มใน Telegram จะไม่ทำงาน
        BASE_URL:'https://9chai-9chai.github.io/4m-system1/' // <<<--- ใส่ URL ของไฟล์นี้
    };
    // +++ END: TELEGRAM CONFIGURATION +++

    // --- TEMPLATES ---
    const TPL = {
        form: `<form id="changeForm" class="space-y-6"><input type="hidden" id="reportId"><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-4">1. ข้อมูลพื้นฐาน</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="changeType" class="block text-sm font-medium text-gray-700">ประเภท 4M</label><select id="changeType" required class="mt-1 block w-full rounded-md border-gray-300"><option value="">-- เลือกประเภท --</option><option value="Man">Man</option><option value="Machine">Machine</option><option value="Material">Material</option><option value="Method">Method</option></select></div><div><label for="docNumber" class="block text-sm font-medium text-gray-700">เอกสารควบคุม (ถ้ามี)</label><input type="text" id="docNumber" placeholder="เช่น WI-PR-001" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="changeLine" class="block text-sm font-medium text-gray-700">ไลน์การผลิต</label><input list="lines-list" type="text" id="changeLine" required placeholder="พิมพ์เพื่อค้นหา..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="lines-list"></datalist></div><div><label for="partName" class="block text-sm font-medium text-gray-700">ชื่อชิ้นงาน</label><input list="parts-list" type="text" id="partName" required placeholder="พิมพ์เพื่อค้นหา..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="parts-list"></datalist></div><div class="sm:col-span-2"><label for="reporterName" class="block text-sm font-medium text-gray-700">ชื่อผู้รายงาน</label><input type="text" id="reporterName" required placeholder="เช่น สมชาย ใจดี" class="mt-1 block w-full rounded-md border-gray-300"></div></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><div class="flex justify-between items-center mb-2"><h3 class="text-lg font-semibold text-gray-700">2. เหตุผลการเปลี่ยนแปลง</h3><div class="text-right"><p class="text-sm text-gray-500">คะแนนความเสี่ยง</p><p id="riskScoreDisplay" class="font-bold text-xl text-blue-600">0</p></div></div><p class="text-sm text-gray-500 mb-4">เลือกสาเหตุ (ระบบจะคำนวณความเสี่ยงอัตโนมัติ)</p><div id="reasonCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4"><p class="text-gray-400 col-span-full">กรุณาเลือกประเภท 4M ก่อน</p></div><div><label for="otherReason" class="block text-sm font-medium text-gray-700">รายละเอียดเพิ่มเติม</label><textarea id="otherReason" rows="2" class="mt-1 block w-full rounded-md border-gray-300" placeholder="อธิบายเพิ่มเติม..."></textarea></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-2">3. มาตรการตอบโต้ และผู้รับผิดชอบ</h3><p class="text-sm font-medium text-gray-700 mb-2">มาตรการตอบโต้หลัก (เลือกได้หลายข้อ)</p><div id="mainCountermeasuresCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4"><p class="text-gray-400 col-span-full">กรุณาเลือกประเภท 4M ก่อน</p></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t pt-4"><div><label for="dueDate" class="block text-sm font-medium text-gray-700">กำหนดเสร็จ</label><input type="date" id="dueDate" required class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="responsible" class="block text-sm font-medium text-gray-700">ผู้รับผิดชอบหลัก</label><input list="responsibles-list" type="text" id="responsible" required placeholder="พิมพ์เพื่อค้นหา..." class="mt-1 block w-full rounded-md border-gray-300"><datalist id="responsibles-list"></datalist></div></div></div><div class="form-section p-4 rounded-r-lg bg-gray-50"><h3 class="text-lg font-semibold text-gray-700 mb-2">4. มาตรการเฝ้าระวังเพิ่มเติม</h3><p class="text-sm text-gray-500 mb-4">เลือกมาตรการสำหรับควบคุมและเฝ้าระวังคุณภาพหลังการเปลี่ยนแปลง (เลือกได้หลายข้อ)</p><div id="surveillanceMeasuresCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div><div class="flex items-center space-x-2 sm:col-span-2 mt-2 pt-2 border-t"><label for="surveillanceOtherCheckbox" class="flex items-center text-sm flex-shrink-0"><input type="checkbox" id="surveillanceOtherCheckbox" class="rounded border-gray-300"><span class="ml-2 text-gray-700">อื่นๆ (โปรดระบุ):</span></label><input type="text" id="surveillanceOtherText" class="hidden flex-grow rounded-md border-gray-300 text-sm" placeholder="ระบุมาตรการเพิ่มเติม..."></div></div><div class="flex justify-end pt-4"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center space-x-2"><i class="w-6 h-6" data-feather="save"></i><span>บันทึกข้อมูล</span></button></div></form>`,
        board: `<div class="bg-gray-50 p-4 rounded-lg mb-4 border grid grid-cols-1 sm:grid-cols-4 gap-4"><div><label for="filterDate" class="block text-sm text-gray-700">วันที่</label><input type="date" id="filterDate" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="filterText" class="block text-sm text-gray-700">ค้นหา</label><input type="text" id="filterText" placeholder="ไลน์, ชิ้นงาน, ผู้รายงาน..." class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="filterStatus" class="block text-sm text-gray-700">สถานะ</label><select id="filterStatus" class="mt-1 block w-full rounded-md border-gray-300"><option value="">ทั้งหมด</option></select></div><div><label for="filterRisk" class="block text-sm text-gray-700">ความเสี่ยง</label><select id="filterRisk" class="mt-1 block w-full rounded-md border-gray-300"><option value="">ทั้งหมด</option><option value="High">สูง</option><option value="Medium">ปานกลาง</option><option value="Low">ต่ำ</option></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"><div id="board-Man" class="bg-blue-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-blue-800 mb-3 text-center">MAN</h2><div class="space-y-3"></div></div><div id="board-Machine" class="bg-yellow-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-yellow-800 mb-3 text-center">MACHINE</h2><div class="space-y-3"></div></div><div id="board-Material" class="bg-green-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-green-800 mb-3 text-center">MATERIAL</h2><div class="space-y-3"></div></div><div id="board-Method" class="bg-purple-50 p-3 rounded-lg"><h2 class="text-xl font-bold text-purple-800 mb-3 text-center">METHOD</h2><div class="space-y-3"></div></div></div><div id="no-data-message" class="hidden text-center text-gray-500 py-10"><i class="w-16 h-16 mx-auto text-gray-400" data-feather="folder-off"></i><p class="mt-4 text-lg">ไม่พบข้อมูล</p></div>`,
        dashboard: `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">5 อันดับสาเหตุการเปลี่ยนแปลง</h3><canvas id="reasonsChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">สัดส่วนการเปลี่ยนแปลง 4M</h3><canvas id="typesChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">ไลน์ผลิตที่เกิดการเปลี่ยนแปลง</h3><canvas id="linesChart"></canvas></div><div class="bg-gray-50 p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 text-center mb-2">ของเสียที่เกิดจาก 4M Change</h3><canvas id="defectsChart"></canvas></div></div>`,
        modals: `<div id="qaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-bold mb-4">บันทึกผลตรวจสอบ (Verification)</h3><form id="qaForm"><input type="hidden" id="qaReportId"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">ผลการตรวจสอบคุณภาพ</label><div class="flex items-center space-x-4 mt-1"><label class="flex items-center"><input type="radio" name="qaResult" value="OK" class="text-green-600"><span class="ml-2 text-green-700 font-semibold">OK</span></label><label class="flex items-center"><input type="radio" name="qaResult" value="NG" class="text-red-600"><span class="ml-2 text-red-700 font-semibold">NG</span></label></div></div><div id="defectSection" class="hidden"><label for="defectCode" class="block text-sm font-medium text-gray-700">รหัสของเสีย (ถ้ามี)</label><select id="defectCode" class="mt-1 block w-full rounded-md border-gray-300"></select></div><div><label for="verifiedBy" class="block text-sm font-medium text-gray-700">ชื่อผู้ตรวจสอบ (QA)</label><input type="text" id="verifiedBy" required placeholder="เช่น สุภาพร QC" class="mt-1 block w-full rounded-md border-gray-300"></div><div><label for="qaEvidence" class="block text-sm font-medium text-gray-700">แนบหลักฐาน</label><input type="file" id="qaEvidence" accept="image/*,.pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="imagePreview" class="hidden mt-2 max-h-40 rounded"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">ยกเลิก</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">ยืนยันผล</button></div></form></div></div> <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><h3 class="text-lg font-bold mb-4">ตั้งค่า Master Data (จำลอง)</h3><form id="settingsForm" class="space-y-4"><div><label for="masterParts" class="block text-sm font-medium text-gray-700">รายชื่อชิ้นงาน (คั่นด้วยลูกน้ำ ,)</label><textarea id="masterParts" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div><div><label for="masterLines" class="block text-sm font-medium text-gray-700">ไลน์ผลิต (คั่นด้วยลูกน้ำ ,)</label><textarea id="masterLines" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div><div><label for="masterResponsibles" class="block text-sm font-medium text-gray-700">ผู้รับผิดชอบ (คั่นด้วยลูกน้ำ ,)</label><textarea id="masterResponsibles" rows="3" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div></form><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-close-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">ปิด</button><button type="button" id="saveSettingsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">บันทึกค่า</button></div></div></div> <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><div class="flex justify-between items-center"><h3 class="text-lg font-bold mb-4">ประวัติการดำเนินการ (Action History)</h3><button type="button" class="modal-close-btn text-gray-400 hover:text-gray-600">×</button></div><div id="historyContent" class="text-sm space-y-2 max-h-80 overflow-y-auto"></div></div></div>`
    };

    // --- DATA MAPPING ---
    const REASONS_BY_TYPE = {'Man': ['พนักงานใหม่','พนักงานขาดงาน/ลา','สลับตำแหน่ง/หน้าที่','หัวหน้างานใหม่','พนักงานทักษะไม่พอ','ลดจำนวนคนในไลน์','เพิ่มกะ/คนทำงาน','เปลี่ยน Job Leader','ไม่ปฏิบัติตาม WI','ความเหนื่อยล้า/สุขภาพ','การอบรมไม่เพียงพอ'],'Machine': ['เปลี่ยนแม่พิมพ์ (Mold)','เครื่องจักร Breakdown','เปลี่ยน Parameter ฉีด','ซ่อมบำรุงฉุกเฉิน','เปลี่ยน Jig/Fixture','ติดตั้งเครื่องจักรใหม่','ระบบไฟฟ้า/ลมอัดขัดข้อง','เครื่องมือวัดเสีย/ไม่ Calibrate','เปลี่ยน Robot Program','Cooling System มีปัญหา','Heater ขาด'],'Material': ['เปลี่ยน Lot วัตถุดิบ','เปลี่ยนเกรด/Supplier','ใช้วัสดุทดแทน','วัตถุดิบหมดสต็อก','วัตถุดิบ Spec ไม่ตรง','เปลี่ยนสี/Masterbatch','เปลี่ยน Packaging','วัตถุดิบมีความชื้นสูง','ใช้ Re-grind material','ส่วนผสม/อัตราส่วนผิด','วัตถุดิบปนเปื้อน'],'Method': ['เปลี่ยน Work Instruction (WI)','ลด/เพิ่ม Cycle Time','เพิ่ม/ลดขั้นตอนทำงาน','เปลี่ยน Layout การผลิต','ทดลองงานใหม่ (Trial)','เปลี่ยนวิธีการตรวจสอบ','เปลี่ยนวิธีการ Packing','ปรับปรุง Kaizen','ทำงานไม่ตามขั้นตอน','ไม่มีมาตรฐานรองรับ','วิธีการ Set up เปลี่ยนไป']};
    const newCountermeasure = 'หัวหน้ากลุ่มสุ่มตรวจ 5 ชิ้น ทุก 2 ชั่วโมง';
    const COUNTERMEASURES_BY_TYPE = {
        'Man': ['หยุดไลน์และแจ้งหัวหน้า','เปลี่ยนคนมีทักษะมาทำแทน','หัวหน้างานสอนและควบคุม','ลดความเร็วผลิตชั่วคราว','ตรวจสอบ 100% ท้ายไลน์', newCountermeasure, 'QC ตรวจสอบพิเศษ','จัดทำ OPL สอนงานด่วน','วิศวกร/เทคนิคเชี่ยนยืนยัน','บันทึกประวัติการอบรม','ทำงานคู่กับคนเก่า','ทบทวน Skill Matrix'],
        'Machine': ['หยุดเครื่องและแจ้งซ่อม','วิศวกรยืนยัน Parameter','ตรวจสอบ First-off 5 ชิ้น','เฝ้าระวังเครื่องจักรพิเศษ','เพิ่มความถี่ตรวจชิ้นงาน', newCountermeasure, 'แยก Lot ที่ได้รับผลกระทบ','ห้ามปรับ Parameter','ตรวจ Calibrate เครื่องมือวัด','ทำความสะอาดแม่พิมพ์/เครื่อง','บันทึกประวัติซ่อม','ตรวจระบบหล่อเย็น/Heater'],
        'Material': ['หยุดใช้วัตถุดิบที่มีปัญหา','ส่ง QA ตรวจสอบ','ติดต่อ Supplier ยืนยัน Spec','Trial run วัตถุดิบใหม่','อบไล่ความชื้นก่อนใช้', newCountermeasure, 'แยก/ติดป้าย Lot ใหม่','ตรวจสอบย้อนกลับ Lot ที่ใช้','ตรวจสอบสี/ลักษณะกายภาพ','ขอเอกสาร CoA','กักกันสินค้าต้องสงสัย','ปรับ Parameter ฉีดให้เหมาะ'],
        'Method': ['หยุดไลน์ทบทวน WI','ออก WI ชั่วคราว','QA ยืนยันคุณภาพก่อนเดินงาน','สื่อสารการเปลี่ยนแปลงทั่วถึง','วิศวกรยืนยันการเปลี่ยนแปลง', newCountermeasure, 'บันทึกใน Log Book','Audit กระบวนการหลังเปลี่ยน','ตรวจ First/Last Piece','กำหนดจุดตรวจสอบพิเศษ','ทบทวน FMEA/Control Plan','อบรมพนักงานตาม WI ใหม่']
    };
    const SURVEILLANCE_MEASURES = ['ติดป้ายเหลือง \'4M Change\' ที่กล่อง/Rack และแจ้ง QA', 'พนักงานตรวจสอบชิ้นงาน 100% ก่อนลงกล่อง', 'แยก Lot การผลิต 3 ชั่วโมงแรกเพื่อรอผล QA', 'วิศวกร/เทคนิคเชี่ยนตรวจสอบ Parameter ซ้ำใน 1 ชม.', 'บันทึกข้อมูลในใบบันทึกการควบคุมพิเศษ', 'เก็บตัวอย่าง First Shot / Last Shot ของแต่ละกะ', 'ถ่ายรูปชิ้นงาน OK/NG ติดไว้ที่หน้าเครื่อง', 'สื่อสารการเปลี่ยนแปลงให้พนักงานกะต่อไปรับทราบ', 'ห้ามส่งมอบงานให้คลังสินค้าจนกว่าจะได้รับอนุมัติ', 'เพิ่มความถี่ในการตรวจสอบด้วยเครื่องมือวัด', 'ตรวจสอบ Visual Defect เทียบกับ Limit Sample'];
    const RISK_SCORES = {'พนักงานใหม่':3,'พนักงานขาดงาน/ลา':2,'สลับตำแหน่ง/หน้าที่':2,'พนักงานทักษะไม่พอ':4,'เครื่องจักร Breakdown':5,'ซ่อมบำรุงฉุกเฉิน':5,'เปลี่ยนเกรด/Supplier':4,'วัตถุดิบ Spec ไม่ตรง':4,'วัตถุดิบปนเปื้อน':5,'เปลี่ยน Work Instruction (WI)':3,'ทดลองงานใหม่ (Trial)':4};
    const DEFECT_CODES = ['ไม่มี','รอยบุบ (Dent)','รอยขีดข่วน (Scratch)','แฟลช (Flash)','ฉีดไม่เต็ม (Short Shot)','รอยยุบ (Sink Mark)','สีเพี้ยน (Color Mismatch)','สิ่งปนเปื้อน (Contamination)','ขนาดผิด Spec (Dimension NG)','อื่นๆ'];
    const STATUS_WORKFLOW = {'Open':{text:'Open',color:'bg-gray-400 text-white',next:'Acknowledged',buttonText:'รับทราบปัญหา'},'Acknowledged':{text:'รับทราบแล้ว',color:'bg-yellow-500 text-white',next:'Action Taken',buttonText:'บันทึกการดำเนินการ'},'Action Taken':{text:'ดำเนินการแล้ว',color:'bg-blue-500 text-white',next:'Verified',buttonText:'ตรวจสอบผล (QA)'},'Verified':{text:'ตรวจสอบแล้ว',color:'bg-indigo-500 text-white',next:'Closed',buttonText:'ปิดงาน'},'Closed':{text:'Closed',color:'bg-green-600 text-white',next:null,buttonText:null}};
    
    // --- STATE ---
    let reports = [];
    let masterData = { parts: [], lines: [], responsibles: [] };
    let appDOMElements = {};
    let highlightedReportId = null; // <<< [WORLD CLASS UPDATE] ตัวแปรสำหรับเก็บ ID ที่จะไฮไลท์

    // +++ START: TELEGRAM FUNCTION (UPGRADED) +++
    // <<< [WORLD CLASS UPDATE] ปรับปรุงฟังก์ชันให้รองรับปุ่ม Action
    async function sendTelegramNotification(message, actionUrl = null) {
        if (!TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID || TELEGRAM_CONFIG.CHAT_ID === 'YOUR_CHAT_ID_HERE') {
            const simulatedMessage = actionUrl ? `${message}\n\n[ปุ่มจำลอง: ดูบน Board]\n(ลิงค์ไปที่: ${actionUrl})` : message;
            console.error('Telegram BOT_TOKEN or CHAT_ID is not configured.');
            showNotification(`[จำลอง Telegram]\n${simulatedMessage.replace(/[*_~`>#+\-=|{}.!]/g, '\\$&')}`);
            return;
        }

        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
        const params = new URLSearchParams({
            chat_id: TELEGRAM_CONFIG.CHAT_ID,
            text: message,
            parse_mode: 'Markdown'
        });

        // สร้างปุ่ม Inline ถ้ามี actionUrl และ BASE_URL ถูกตั้งค่า
        if (actionUrl && TELEGRAM_CONFIG.BASE_URL) {
            const inline_keyboard = {
                inline_keyboard: [[
                    { text: '📋 ดูบน 4M Board', url: actionUrl }
                ]]
            };
            params.append('reply_markup', JSON.stringify(inline_keyboard));
        }

        try {
            const response = await fetch(`${url}?${params.toString()}`, { method: 'GET' });
            const data = await response.json();
            if (data.ok) {
                console.log('Telegram message sent successfully!');
            } else {
                console.error('Failed to send Telegram message:', data.description);
                alert(`Error sending Telegram message: ${data.description}`);
            }
        } catch (error) {
            console.error('Error sending Telegram notification:', error);
            alert(`Network error while sending Telegram notification.`);
        }
    }
    // +++ END: TELEGRAM FUNCTION +++

    // --- MAIN FUNCTIONS ---
    function init() {
        document.getElementById('view-container').innerHTML = TPL.form;
        document.getElementById('modal-container').innerHTML = TPL.modals;
        initializeDomElements();
        
        // <<< [WORLD CLASS UPDATE] ตรวจสอบ URL parameters เพื่อทำการไฮไลท์
        handleUrlParameters();

        loadMasterData();
        loadData();
        setupEventListeners();
        
        // ถ้าไม่มีการไฮไลท์ ให้เปิดหน้า form ตามปกติ
        if (!highlightedReportId) {
            switchView('form');
        }
        feather.replace();
    }
    
    // <<< [WORLD CLASS UPDATE] ฟังก์ชันใหม่สำหรับจัดการ URL parameters
    function handleUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view');
        const highlightId = params.get('highlight');

        if (highlightId) {
            highlightedReportId = parseInt(highlightId);
            // บังคับให้ไปหน้า board ถ้ามี parameter highlight
            switchView('board');
        } else if (view) {
            switchView(view);
        }
    }

    function initializeDomElements() {
        appDOMElements = {
            viewContainer: document.getElementById('view-container'),
            tabButtons: document.querySelectorAll('.tab-button'), exportBtn: document.getElementById('exportBtn'), settingsBtn: document.getElementById('settingsBtn'),
            modals: { qa: document.getElementById('qaModal'), settings: document.getElementById('settingsModal'), history: document.getElementById('historyModal') },
            settingsForm: { form: document.getElementById('settingsForm'), parts: document.getElementById('masterParts'), lines: document.getElementById('masterLines'), responsibles: document.getElementById('masterResponsibles'), saveBtn: document.getElementById('saveSettingsBtn') },
            historyContent: document.getElementById('historyContent')
        };
    }

    function setupEventListeners() {
        appDOMElements.tabButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        appDOMElements.exportBtn.addEventListener('click', exportToExcel);
        appDOMElements.settingsBtn.addEventListener('click', openSettingsModal);
        document.getElementById('modal-container').addEventListener('click', e => {
            if (e.target.classList.contains('modal-close-btn')) {
                e.target.closest('.fixed').classList.add('hidden');
            }
        });
        appDOMElements.settingsForm.saveBtn.addEventListener('click', saveSettings);
    }
    
    function setupViewEventListeners(view) {
        if(view === 'form') {
            const form = document.getElementById('changeForm');
            form.addEventListener('submit', handleFormSubmit);
            document.getElementById('changeType').addEventListener('change', updateDynamicFormElements);
            document.getElementById('reasonCheckboxes').addEventListener('change', calculateRiskScore);
            document.getElementById('surveillanceOtherCheckbox')?.addEventListener('change', e => {
                document.getElementById('surveillanceOtherText').classList.toggle('hidden', !e.target.checked);
                if (e.target.checked) {
                    document.getElementById('surveillanceOtherText').focus();
                }
            });
        }
        if(view === 'board') {
            document.querySelectorAll('#filterDate, #filterText, #filterStatus, #filterRisk').forEach(filter => {
                filter.addEventListener('input', renderBoard);
            });
        }
        if(view === 'qaModal') {
            const qaForm = document.getElementById('qaForm');
            qaForm.addEventListener('submit', handleQaSubmit);
            qaForm.qaResult.forEach(radio => radio.addEventListener('change', e => {
                document.getElementById('defectSection').style.display = e.target.value === 'NG' ? 'block' : 'none';
            }));
        }
    }

    function switchView(viewName) {
        // <<< [WORLD CLASS UPDATE] ล้าง highlightId เมื่อเปลี่ยน view ด้วยตนเอง
        if (viewName !== 'board' && highlightedReportId) {
             highlightedReportId = null;
        }

        appDOMElements.tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
        appDOMElements.viewContainer.innerHTML = TPL[viewName];
        if (viewName === 'form') {
            updateDynamicFormElements();
            populateDatalists();
            setupViewEventListeners('form');
        }
        if (viewName === 'board') {
            populateStaticDropdowns();
            renderBoard();
            setupViewEventListeners('board');
        }
        if (viewName === 'dashboard') renderDashboard();
        feather.replace();
    }
    
    function handleFormSubmit(e) {
        e.preventDefault();
        const score = calculateRiskScore();
        if (score === 0 && !document.getElementById('otherReason').value) { alert('กรุณาเลือกเหตุผลอย่างน้อย 1 ข้อ'); return; }
        
        const surveillanceMeasures = getCheckedValues(document.getElementById('surveillanceMeasuresCheckboxes'));
        const otherCheckbox = document.getElementById('surveillanceOtherCheckbox');
        const otherText = document.getElementById('surveillanceOtherText');
        if (otherCheckbox.checked && otherText.value.trim() !== '') {
            surveillanceMeasures.push(`อื่นๆ: ${otherText.value.trim()}`);
        }

        const reportId = document.getElementById('reportId').value;
        const reporterName = document.getElementById('reporterName').value;

        if (reportId) { // --- UPDATE EXISTING REPORT ---
            const reportToUpdate = reports.find(r => r.id == reportId);
            if(reportToUpdate) {
                reportToUpdate.type = document.getElementById('changeType').value;
                reportToUpdate.line = document.getElementById('changeLine').value;
                reportToUpdate.partName = document.getElementById('partName').value;
                reportToUpdate.reporter = reporterName;
                reportToUpdate.docNumber = document.getElementById('docNumber').value;
                reportToUpdate.risk = { score: score, level: score > 7 ? 'High' : (score > 3 ? 'Medium' : 'Low') };
                reportToUpdate.reason = [...getCheckedValues(document.getElementById('reasonCheckboxes')), ...(document.getElementById('otherReason').value ? [`อื่นๆ: ${document.getElementById('otherReason').value}`] : [])].join('; ');
                reportToUpdate.countermeasure.main = getCheckedValues(document.getElementById('mainCountermeasuresCheckboxes'));
                reportToUpdate.countermeasure.surveillance = surveillanceMeasures;
                reportToUpdate.countermeasure.dueDate = document.getElementById('dueDate').value;
                reportToUpdate.countermeasure.responsible = document.getElementById('responsible').value;
                
                addHistory(reportToUpdate, 'แก้ไขข้อมูล', reporterName);
                showNotification('อัปเดตข้อมูลสำเร็จ!');
            }
        } else { // --- CREATE NEW REPORT ---
            const newReport = {
                id: Date.now(), timestamp: new Date().toISOString(), type: document.getElementById('changeType').value,
                line: document.getElementById('changeLine').value, partName: document.getElementById('partName').value, reporter: reporterName, docNumber: document.getElementById('docNumber').value,
                risk: { score: score, level: score > 7 ? 'High' : (score > 3 ? 'Medium' : 'Low') },
                reason: [...getCheckedValues(document.getElementById('reasonCheckboxes')), ...(document.getElementById('otherReason').value ? [`อื่นๆ: ${document.getElementById('otherReason').value}`] : [])].join('; '),
                countermeasure: {
                    main: getCheckedValues(document.getElementById('mainCountermeasuresCheckboxes')), 
                    surveillance: surveillanceMeasures, 
                    dueDate: document.getElementById('dueDate').value, 
                    responsible: document.getElementById('responsible').value, 
                    notes: ''
                },
                status: 'Open', 
                qa: { result: null, evidence: null, timestamp: null, defect: null, verifiedBy: null },
                history: [{ timestamp: new Date().toISOString(), action: 'สร้างเคส', user: reporterName }]
            };
            reports.unshift(newReport);
            
            // +++ SEND TELEGRAM NOTIFICATION FOR NEW CASE (UPGRADED) +++
            const riskEmoji = newReport.risk.level === 'High' ? '🚨' : (newReport.risk.level === 'Medium' ? '⚠️' : 'ℹ️');
            const message = `
${riskEmoji} *New 4M Change*
*Case ID:* \`${newReport.id}\`
*Type:* ${newReport.type}
*Part:* ${newReport.partName}
*Line:* ${newReport.line}
*Risk:* ${newReport.risk.level} (${newReport.risk.score})
*Reason:* ${newReport.reason.substring(0, 100)}...
--------------------------------------
👤 *เรียน:* ${newReport.countermeasure.responsible}
👉 *โปรดดำเนินการขั้นต่อไป (Acknowledge)*
            `.trim();
            // <<< [WORLD CLASS UPDATE] ส่ง URL ไปกับ Notification
            const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${newReport.id}`;
            sendTelegramNotification(message, actionUrl);

            showNotification('บันทึกการเปลี่ยนแปลงสำเร็จ และส่งแจ้งเตือนแล้ว!');
        }

        saveData();
        switchView('board');
    }

    // --- CARD & WORKFLOW ---
    function createReportCard(report) {
        const card = document.createElement('div');
        // <<< [WORLD CLASS UPDATE] เพิ่ม ID ให้กับ Element ของการ์ด
        card.id = `report-card-${report.id}`;
        card.className = "bg-white rounded-lg shadow-md border-t-4 p-3 flex flex-col space-y-3";
        const riskClass = report.risk.level === 'High' ? 'risk-high' : (report.risk.level === 'Medium' ? 'risk-medium' : 'risk-low');
        const typeColorMapping = {'Man':'border-blue-500', 'Machine':'border-yellow-500', 'Material':'border-green-500', 'Method':'border-purple-500'};
        card.classList.add(typeColorMapping[report.type]);

        const isOverdue = !['Closed'].includes(report.status) && new Date(report.countermeasure.dueDate) < new Date();
        const statusInfo = STATUS_WORKFLOW[report.status];
        
        const formattedDate = new Date(report.timestamp).toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        const qaSummary = report.qa.result 
            ? `<div class="p-2 rounded-md bg-gray-100 text-xs mt-1"><p><strong>ผล:</strong> <span class="font-bold ${report.qa.result === 'OK' ? 'qa-ok' : 'qa-ng'}">${report.qa.result}</span></p>${report.qa.defect && report.qa.defect !== 'ไม่มี' ? `<p><strong>ของเสีย:</strong> ${report.qa.defect}</p>` : ''}<p><strong>ผู้ตรวจ:</strong> ${report.qa.verifiedBy || 'N/A'}</p></div>`
            : '';
            
        let actionButton = statusInfo.next 
            ? `<button data-id="${report.id}" data-action="${report.status}" class="action-btn w-full mt-auto text-sm py-1.5 rounded font-semibold ${statusInfo.color} hover:opacity-80">${statusInfo.buttonText}</button>`
            : `<div class="text-center text-sm py-1.5 text-green-700 font-semibold">Completed</div>`;
        
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="text-base font-bold text-gray-900 leading-tight">${report.partName}</h4>
                        <p class="text-sm font-semibold text-gray-500">${report.line}</p>
                        <p class="text-xs text-gray-400 mt-1">${formattedDate} น.</p>
                    </div>
                    <div class="flex-shrink-0 flex flex-col items-end space-y-1">
                        <span class="status-badge ${riskClass}">${report.risk.level} Risk (${report.risk.score})</span>
                        <span class="status-badge ${statusInfo.color}">${statusInfo.text}</span>
                        ${isOverdue ? `<span class="status-badge bg-red-600 text-white overdue-pulse">OVERDUE</span>` : ''}
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded" title="${report.reason}"><i data-feather="alert-circle" class="w-3 h-3 inline-block -mt-1"></i> ${report.reason.substring(0, 80)}...</p>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-xs border-t pt-2">
                <div title="ผู้รายงาน"><i data-feather="user" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${report.reporter}</span></div>
                <div title="ผู้รับผิดชอบ"><i data-feather="user-check" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${report.countermeasure.responsible}</span></div>
                <div title="กำหนดเสร็จ"><i data-feather="calendar" class="w-3.5 h-3.5 inline-block text-gray-400"></i> <span class="text-gray-700">${new Date(report.countermeasure.dueDate).toLocaleDateString('th-TH')}</span></div>
            </div>

            <details class="text-xs bg-gray-50 rounded">
                <summary class="cursor-pointer p-1 font-semibold text-gray-600">ดูมาตรการ & ผล QA...</summary>
                <div class="p-2 border-t space-y-2">
                    ${(report.countermeasure.main && report.countermeasure.main.length > 0) ? `<div><p class="card-section-header">มาตรการตอบโต้หลัก</p><ul class="list-disc list-inside text-gray-700">${report.countermeasure.main.map(c => `<li>${c}</li>`).join('')}</ul></div>` : ''}
                    ${(report.countermeasure.surveillance && report.countermeasure.surveillance.length > 0) ? `<div><p class="card-section-header">มาตรการเฝ้าระวัง</p><ul class="list-disc list-inside text-gray-700">${report.countermeasure.surveillance.map(s => `<li>${s}</li>`).join('')}</ul></div>` : ''}
                    <div><p class="card-section-header">Action Log</p><p class="text-gray-700 italic">${report.countermeasure.notes || 'ยังไม่มีการบันทึก'}</p></div>
                    <div><p class="card-section-header">Verification Summary</p>${qaSummary || '<p class="text-gray-500 italic">รอการตรวจสอบ</p>'}</div>
                </div>
            </details>
            
            <div class="border-t pt-2 mt-auto flex justify-between items-center">
                <div class="flex-grow pr-2">${actionButton}</div>
                <div class="flex-shrink-0 flex items-center space-x-1">
                    <button title="ส่งแจ้งเตือน" data-id="${report.id}" class="remind-btn text-gray-400 hover:text-blue-600 p-1 ${report.status === 'Closed' ? 'hidden' : ''}"><i data-feather="bell" class="w-4 h-4"></i></button>
                    <button title="ประวัติ" data-id="${report.id}" class="history-btn text-gray-400 hover:text-blue-600 p-1"><i data-feather="clock" class="w-4 h-4"></i></button>
                    <button title="แก้ไข" data-id="${report.id}" class="edit-btn text-gray-400 hover:text-yellow-600 p-1"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                    <button title="ลบ" data-id="${report.id}" class="delete-btn text-gray-400 hover:text-red-600 p-1"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        `;
        card.querySelector('.action-btn')?.addEventListener('click', handleActionClick);
        card.querySelector('.remind-btn')?.addEventListener('click', handleRemindClick);
        card.querySelector('.history-btn')?.addEventListener('click', showHistoryModal);
        card.querySelector('.edit-btn')?.addEventListener('click', handleEditClick);
        card.querySelector('.delete-btn')?.addEventListener('click', handleDeleteClick);
        return card;
    }

    // +++ Manual Reminder Click Handler (UPGRADED) +++
    async function handleRemindClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const report = reports.find(r => r.id === id);
        if (!report) return;

        if (!confirm(`ต้องการส่งแจ้งเตือนสำหรับเคส #${report.id} (${report.partName}) หรือไม่?`)) return;

        let message, actionNeeded = '', target = '';
        switch (report.status) {
            case 'Open': target = report.countermeasure.responsible; actionNeeded = 'รับทราบปัญหา (Acknowledge)'; break;
            case 'Acknowledged': target = report.countermeasure.responsible; actionNeeded = 'บันทึกการดำเนินการ (Action Taken)'; break;
            case 'Action Taken': target = 'ทีม QA'; actionNeeded = 'ตรวจสอบผล (Verification)'; break;
            case 'Verified': report.qa.result === 'NG' ? (target = report.countermeasure.responsible, actionNeeded = `ดำเนินการแก้ไขใหม่จากผล QA ที่เป็น NG`) : (target = report.countermeasure.responsible, actionNeeded = `ปิดงาน (Close Case)`); break;
            default: showNotification('เคสนี้อยู่ในสถานะที่ไม่ต้องการการแจ้งเตือน'); return;
        }

        message = `
🔔 *Reminder: 4M Change*
*Case ID:* \`${report.id}\` (${report.partName})
*Line:* ${report.line}
*Current Status:* ${STATUS_WORKFLOW[report.status].text}
--------------------------------------
‼️ *เรียน:* ${target}
👉 *โปรดดำเนินการขั้นต่อไป:* ${actionNeeded}
        `.trim();
        // <<< [WORLD CLASS UPDATE] ส่ง URL ไปกับ Notification
        const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;
        await sendTelegramNotification(message, actionUrl);
        showNotification('ส่งแจ้งเตือนสำเร็จ!');
    }
    
    function handleActionClick(e) {
        const id = parseInt(e.target.dataset.id), action = e.target.dataset.action;
        const report = reports.find(r => r.id === id);
        if (!report) return;

        const nextStatus = STATUS_WORKFLOW[action].next;
        const user = prompt(`ยืนยันชื่อผู้ดำเนินการ:`, report.reporter);
        if (!user) return;
        
        let message = '';
        // <<< [WORLD CLASS UPDATE] ส่ง URL ไปกับ Notification
        const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;

        if (action === 'Open') { 
            report.status = nextStatus;
            addHistory(report, 'รับทราบปัญหา', user);
            showNotification(`เคส #${report.id} ได้รับการ Acknowledge แล้ว`);
        } else if (action === 'Acknowledged') { 
            const notes = prompt('กรุณาบันทึกการดำเนินการ:', report.countermeasure.notes);
            if(notes !== null) { 
                report.countermeasure.notes = notes; 
                report.status = nextStatus;
                addHistory(report, 'บันทึกการดำเนินการ', user);
                message = `
📝 *Action Taken*
*Case ID:* \`${report.id}\` (${report.partName})
*Action Note:* ${notes}
*Taken by:* ${user}
--------------------------------------
🔬 *เรียน: ทีม QA*
👉 *โปรดดำเนินการตรวจสอบ (Verification)*
                `.trim();
                sendTelegramNotification(message, actionUrl);
            }
        } else if (action === 'Action Taken') { openQaModal(id); return; } 
        else if (action === 'Verified') {
            if(report.qa.result !== 'OK') { alert('ไม่สามารถปิดงานได้เนื่องจากผล QA เป็น NG'); return; }
            report.status = nextStatus;
            addHistory(report, 'ปิดงาน', user);
            message = `
🏁 *Case Closed*
*Case ID:* \`${report.id}\` (${report.partName})
*Line:* ${report.line}
*Closed by:* ${user}
--------------------------------------
เคสนี้ได้ดำเนินการเสร็จสิ้นทุกขั้นตอนแล้ว
            `.trim();
            // ไม่ต้องส่ง link สำหรับเคสที่ปิดแล้ว
            sendTelegramNotification(message);
            showNotification(`เคส #${report.id} ถูกปิดเรียบร้อย`);
        }
        
        saveData();
        renderBoard();
    }

    function handleDeleteClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const reportToDelete = reports.find(r => r.id === id);
        if (reportToDelete && confirm(`คุณต้องการลบเคสของ '${reportToDelete.partName}' ใช่หรือไม่?`)) {
            reports = reports.filter(r => r.id !== id);
            saveData();
            renderBoard();
            showNotification('ลบเคสสำเร็จ');
        }
    }

    function handleEditClick(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const reportToEdit = reports.find(r => r.id === id);
        if (reportToEdit) {
            switchView('form');
            populateFormForEdit(reportToEdit);
        }
    }

    function populateFormForEdit(report) {
        document.getElementById('reportId').value = report.id;
        document.getElementById('changeType').value = report.type;
        document.getElementById('docNumber').value = report.docNumber;
        document.getElementById('changeLine').value = report.line;
        document.getElementById('partName').value = report.partName;
        document.getElementById('reporterName').value = report.reporter;
        updateDynamicFormElements();
        const reasons = report.reason.split('; ');
        reasons.forEach(reason => {
            if (reason.startsWith('อื่นๆ:')) {
                document.getElementById('otherReason').value = reason.replace('อื่นๆ: ', '');
            } else {
                const checkbox = document.querySelector(`#reasonCheckboxes input[value="${reason}"]`);
                if(checkbox) checkbox.checked = true;
            }
        });
        report.countermeasure.main.forEach(measure => {
            const checkbox = document.querySelector(`#mainCountermeasuresCheckboxes input[value="${measure}"]`);
            if(checkbox) checkbox.checked = true;
        });
        report.countermeasure.surveillance.forEach(measure => {
            if (measure.startsWith('อื่นๆ:')) {
                document.getElementById('surveillanceOtherCheckbox').checked = true;
                document.getElementById('surveillanceOtherText').value = measure.replace('อื่นๆ: ', '');
                document.getElementById('surveillanceOtherText').classList.remove('hidden');
            } else {
                const checkbox = document.querySelector(`#surveillanceMeasuresCheckboxes input[value="${measure}"]`);
                if(checkbox) checkbox.checked = true;
            }
        });
        document.getElementById('dueDate').value = report.countermeasure.dueDate;
        document.getElementById('responsible').value = report.countermeasure.responsible;
        calculateRiskScore();
    }
    
    function handleQaSubmit(e) {
        e.preventDefault();
        const qaForm = e.target;
        const id = parseInt(qaForm.querySelector('#qaReportId').value);
        const report = reports.find(r => r.id === id);
        if (report) {
            report.qa.result = qaForm.qaResult.value;
            report.qa.defect = report.qa.result === 'NG' ? qaForm.querySelector('#defectCode').value : null;
            report.qa.verifiedBy = qaForm.querySelector('#verifiedBy').value;
            report.qa.timestamp = new Date().toISOString();
            report.status = 'Verified';
            addHistory(report, `ตรวจสอบผล: ${report.qa.result}`, report.qa.verifiedBy);
            
            // +++ SEND TELEGRAM NOTIFICATION FOR QA RESULT (UPGRADED) +++
            const resultEmoji = report.qa.result === 'OK' ? '✅' : '❌';
            const target = report.countermeasure.responsible;
            const resultText = `
${resultEmoji} *QA Verification Result*
*Case ID:* \`${report.id}\` (${report.partName})
*Result:* *${report.qa.result}*
${report.qa.result === 'NG' ? `*Defect:* ${report.qa.defect}` : ''}
*Verified by:* ${report.qa.verifiedBy}
--------------------------------------
👤 *เรียน:* ${target}
👉 *โปรดดำเนินการขั้นต่อไป (${report.qa.result === 'OK' ? 'Close Case' : 'Re-Action'})*
            `.trim();
            // <<< [WORLD CLASS UPDATE] ส่ง URL ไปกับ Notification
            const actionUrl = `${TELEGRAM_CONFIG.BASE_URL}?view=board&highlight=${report.id}`;
            sendTelegramNotification(resultText, actionUrl);

            saveData();
            renderBoard();
            appDOMElements.modals.qa.classList.add('hidden');
        }
    }

    // --- MODALS & NOTIFICATIONS ---
    function openSettingsModal() {
        appDOMElements.settingsForm.parts.value = masterData.parts.join(', ');
        appDOMElements.settingsForm.lines.value = masterData.lines.join(', ');
        appDOMElements.settingsForm.responsibles.value = masterData.responsibles.join(', ');
        appDOMElements.modals.settings.classList.remove('hidden');
    }
    
    function saveSettings() {
        masterData.parts = appDOMElements.settingsForm.parts.value.split(',').map(s => s.trim()).filter(Boolean);
        masterData.lines = appDOMElements.settingsForm.lines.value.split(',').map(s => s.trim()).filter(Boolean);
        masterData.responsibles = appDOMElements.settingsForm.responsibles.value.split(',').map(s => s.trim()).filter(Boolean);
        localStorage.setItem('4m_master_data_v7', JSON.stringify(masterData));
        showNotification('บันทึก Master Data สำเร็จ!');
        appDOMElements.modals.settings.classList.add('hidden');
        if (document.getElementById('changeForm')) populateDatalists();
    }
    
    function showHistoryModal(e) {
        const id = parseInt(e.currentTarget.dataset.id);
        const report = reports.find(r => r.id === id);
        if(!report || !report.history) { appDOMElements.historyContent.innerHTML = 'ไม่มีประวัติ'; return; }
        
        appDOMElements.historyContent.innerHTML = report.history.map(h => 
            `<div class="border-b pb-2"><p><strong>${h.action}</strong> โดย ${h.user}</p><p class="text-gray-500">${new Date(h.timestamp).toLocaleString('th-TH')}</p></div>`
        ).join('');
        appDOMElements.modals.history.classList.remove('hidden');
    }
    
    function showNotification(message) {
        alert(message); // Simple simulation for user feedback
    }

    // --- HELPERS & UTILITIES ---
    function addHistory(report, action, user) {
        if (!report.history) report.history = [];
        report.history.push({ timestamp: new Date().toISOString(), action: action, user: user });
    }
    
    function populateDatalists() {
        document.getElementById('parts-list').innerHTML = masterData.parts.map(p => `<option value="${p}">`).join('');
        document.getElementById('lines-list').innerHTML = masterData.lines.map(l => `<option value="${l}">`).join('');
        document.getElementById('responsibles-list').innerHTML = masterData.responsibles.map(r => `<option value="${r}">`).join('');
    }
    
    function populateStaticDropdowns() { document.querySelector('#filterStatus').innerHTML = `<option value="">สถานะทั้งหมด</option>` + Object.keys(STATUS_WORKFLOW).map(s => `<option value="${s}">${STATUS_WORKFLOW[s].text}</option>`).join(''); document.getElementById('defectCode').innerHTML = DEFECT_CODES.map(d => `<option value="${d}">${d}</option>`).join(''); }
    
    function updateDynamicFormElements() { 
        const type = document.getElementById('changeType')?.value; 
        updateCheckboxes(document.getElementById('reasonCheckboxes'), REASONS_BY_TYPE[type] || []); 
        updateCheckboxes(document.getElementById('mainCountermeasuresCheckboxes'), COUNTERMEASURES_BY_TYPE[type] || []); 
        updateCheckboxes(document.getElementById('surveillanceMeasuresCheckboxes'), SURVEILLANCE_MEASURES);
        calculateRiskScore(); 
    }
    
    function updateCheckboxes(container, options) { if (!container) return; container.innerHTML = options.length === 0 ? `<p class="text-gray-400 col-span-full">กรุณาเลือกประเภท 4M ก่อน</p>` : options.map((option, i) => `<label for="${container.id}-${i}" class="flex items-center text-sm"><input type="checkbox" id="${container.id}-${i}" value="${option}" class="rounded border-gray-300"><span class="ml-2 text-gray-700">${option}</span></label>`).join(''); }
    function calculateRiskScore() { let score = 0; getCheckedValues(document.getElementById('reasonCheckboxes')).forEach(reason => { score += (RISK_SCORES[reason] || 1); }); document.getElementById('riskScoreDisplay').textContent = score; return score; }
    function getCheckedValues(container) { return Array.from(container.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value); }
    // <<< [WORLD CLASS UPDATE] ปรับปรุง renderBoard ให้รองรับการไฮไลท์
    function renderBoard() { const board = document.querySelector('#view-container'); if(!board) return; const Man = board.querySelector('#board-Man .space-y-3'), Machine = board.querySelector('#board-Machine .space-y-3'), Material = board.querySelector('#board-Material .space-y-3'), Method = board.querySelector('#board-Method .space-y-3'); [Man, Machine, Material, Method].forEach(c => c.innerHTML = ''); const fD = board.querySelector('#filterDate'), fT = board.querySelector('#filterText'), fS = board.querySelector('#filterStatus'), fR = board.querySelector('#filterRisk'); const filteredReports = reports.filter(r => { const dF = fD.value ? r.timestamp.startsWith(fD.value) : true; const tFV = fT.value.toLowerCase(); const tF = tFV ? r.line.toLowerCase().includes(tFV) || r.partName.toLowerCase().includes(tFV) || r.reporter.toLowerCase().includes(tFV) : true; const sF = fS.value ? r.status === fS.value : true; const rF = fR.value ? r.risk.level === fR.value : true; return dF && tF && sF && rF; }); board.querySelector('#no-data-message').style.display = filteredReports.length === 0 ? 'block' : 'none'; filteredReports.forEach(report => { const card = createReportCard(report); const container = report.type === 'Man' ? Man : report.type === 'Machine' ? Machine : report.type === 'Material' ? Material : Method; container.appendChild(card); }); feather.replace(); if(highlightedReportId){const cardToHighlight=document.getElementById(`report-card-${highlightedReportId}`);if(cardToHighlight){cardToHighlight.classList.add('card-highlight');cardToHighlight.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>cardToHighlight.classList.remove('card-highlight'),2500);}highlightedReportId=null;}}
    function openQaModal(id) { const report = reports.find(r => r.id === id); appDOMElements.modals.qa.querySelector('#qaReportId').value = id; appDOMElements.modals.qa.querySelector('form').reset(); appDOMElements.modals.qa.querySelector('#verifiedBy').value = ''; appDOMElements.modals.qa.querySelector('#defectSection').style.display = 'none'; appDOMElements.modals.qa.classList.remove('hidden'); }
    function renderDashboard() { if(reports.length === 0) { document.getElementById('view-container').innerHTML = '<p class="text-center text-gray-500">ยังไม่มีข้อมูลสำหรับแสดงผล</p>'; return; } const reasonCounts = reports.flatMap(r => r.reason.split('; ').filter(reason => !reason.startsWith('อื่นๆ:'))).reduce((acc, reason) => { acc[reason] = (acc[reason] || 0) + 1; return acc; }, {}); const top5Reasons = Object.entries(reasonCounts).sort(([,a],[,b]) => b-a).slice(0, 5); const typeCounts = reports.reduce((acc, r) => { acc[r.type] = (acc[r.type] || 0) + 1; return acc; }, {}); const lineCounts = reports.reduce((acc, r) => { acc[r.line] = (acc[r.line] || 0) + 1; return acc; }, {}); const top5Lines = Object.entries(lineCounts).sort(([,a],[,b]) => b-a).slice(0, 5); const defectCounts = reports.filter(r => r.qa.result === 'NG' && r.qa.defect !== 'ไม่มี').reduce((acc, r) => { acc[r.qa.defect] = (acc[r.qa.defect] || 0) + 1; return acc; }, {}); createChart('reasonsChart', 'bar', top5Reasons.map(item => item[0]), top5Reasons.map(item => item[1]), 'จำนวนครั้ง'); createChart('typesChart', 'pie', Object.keys(typeCounts), Object.values(typeCounts)); createChart('linesChart', 'bar', top5Lines.map(item => item[0]), top5Lines.map(item => item[1]), 'จำนวนครั้ง'); createChart('defectsChart', 'bar', Object.keys(defectCounts), Object.values(defectCounts), 'จำนวนครั้ง'); }
    function createChart(canvasId, type, labels, data, label) { const ctx = document.getElementById(canvasId)?.getContext('2d'); if (!ctx) return; if(appDOMElements.charts && appDOMElements.charts[canvasId]) appDOMElements.charts[canvasId].destroy(); if(!appDOMElements.charts) appDOMElements.charts = {}; appDOMElements.charts[canvasId] = new Chart(ctx, { type: type, data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#ef4444', '#6b7280'] }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: type === 'pie' } } } }); }
    function saveData(){ localStorage.setItem('4m_reports_v7', JSON.stringify(reports)); }
    function loadData(){ const data = localStorage.getItem('4m_reports_v7'); if(data) {reports = JSON.parse(data);} }
    function loadMasterData(){ const data = localStorage.getItem('4m_master_data_v7'); if(data) {masterData = JSON.parse(data);} }
    function exportToExcel(){ showNotification('Exporting to Excel... (Simulation)'); }

    init();
});
</script>
</body>
</html>